name: Scribd Downloader

on:
  workflow_dispatch:
    inputs:
      book_url:
        description: 'Scribd, Slideshare, or Everand URL'
        required: true

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout downloader repository
      uses: actions/checkout@v4
      with:
        repository: 'proplayer1131/scribd-downloader'
        token: ${{ secrets.ACTION_TOKEN }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies
      run: npm install

    - name: Normalize URL
      id: normalize
      run: |
        URL="${{ github.event.inputs.book_url }}"
        NORMALIZED_URL=$(echo "$URL" | sed -e 's/^http:/https:/' \
                                           -e 's,://[^.]\+\.scribd\.com,://www.scribd.com,' \
                                           -e 's,://[^.]\+\.slideshare\.net,://www.slideshare.net,' \
                                           -e 's,://[^.]\+\.everand\.com,://www.everand.com,')
        echo "url=$NORMALIZED_URL" >> $GITHUB_OUTPUT

    - name: Run downloader
      id: downloader
      run: npm start "${{ steps.normalize.outputs.url }}"

    - name: Install and configure rclone
      env:
        RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
      run: |
        sudo apt-get update && sudo apt-get install -y rclone
        mkdir -p ~/.config/rclone
        echo "$RCLONE_CONF" > ~/.config/rclone/rclone.conf

    - name: Upload to 1Drive and get link
      id: onedrive
      run: |
        BOOK_FILENAME=$(ls output/* | head -n 1)
        rclone copy "$BOOK_FILENAME" "1drive:Scribd_download" --progress
        PUBLIC_LINK=$(rclone link "1drive:Scribd_download/$(basename "$BOOK_FILENAME")")
        echo "public_link=$PUBLIC_LINK" >> $GITHUB_OUTPUT

    - name: Scrape Document Title
      id: scrape_title
      run: |
        # L·ªánh m·ªõi ch√≠nh x√°c h∆°n: t√¨m ƒë√∫ng kh·ªëi h1, x√≥a tag, x√≥a d√≤ng tr·ªëng
        TITLE=$(curl -sL "${{ steps.normalize.outputs.url }}" | \
                sed -n '/<h1.*data-e2e="doc_page_title"/, /<\/h1>/p' | \
                sed -e 's/<[^>]*>//g' | \
                awk 'NF' | \
                tr -d '\n' | \
                xargs)
        echo "DOCUMENT_TITLE=$TITLE" >> $GITHUB_OUTPUT

    - name: Create Result Message
      if: success()
      run: |
        echo "‚úÖ **T·∫£i S√°ch Ho√†n T·∫•t**" > telegram_message.txt
        echo "üìñ **S√°ch:** ${{ steps.scrape_title.outputs.DOCUMENT_TITLE }}" >> telegram_message.txt
        echo "üîó **Link:** [Nh·∫•n v√†o ƒë√¢y](${{ steps.onedrive.outputs.public_link }})" >> telegram_message.txt

    - name: Upload Result Message
      if: success() && hashFiles('telegram_message.txt') != ''
      uses: actions/upload-artifact@v4
      with:
        name: result-message-${{ github.run_id }}
        path: telegram_message.txt
        retention-days: 1