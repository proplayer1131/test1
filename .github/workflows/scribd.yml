name: Scribd Downloader

on:
  workflow_dispatch:
    inputs:
      book_url:
        description: 'Scribd, Slideshare, or Everand URL'
        required: true

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
          repository: 'proplayer1131/scribd-downloader'
          token: ${{ secrets.ACTION_TOKEN }}

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'

    - name: Install dependencies
      run: npm install

    - name: Run downloader
      id: downloader
      run: |
        npm start "${{ github.event.inputs.book_url }}"
        echo "::set-output name=book_filename::$(ls output/*.pdf | xargs -n 1 basename)"


    - name: Install and configure rclone
      env:
        RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
      run: |
        sudo apt-get update && sudo apt-get install -y rclone
        mkdir -p ~/.config/rclone
        echo "$RCLONE_CONF" > ~/.config/rclone/rclone.conf

    - name: Upload to OneDrive and get link
      id: onedrive
      run: |
        BOOK_FILENAME="${{ steps.downloader.outputs.book_filename }}"
        rclone copy "output/$BOOK_FILENAME" "onedrive:Scribd download"
        PUBLIC_LINK=$(rclone link "onedrive:Scribd download/$BOOK_FILENAME")
        echo "::set-output name=public_link::$PUBLIC_LINK"

    - name: Send notification to Telegram
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        message: |
          Downloaded: ${{ steps.downloader.outputs.book_filename }}
          Download link: ${{ steps.onedrive.outputs.public_link }}
