name: Scribd Downloader

on:
  workflow_dispatch:
    inputs:
      book_url:
        description: 'Scribd, Slideshare, or Everand URL'
        required: true

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout downloader repository
      uses: actions/checkout@v4
      with:
        repository: 'proplayer1131/scribd-downloader'
        token: ${{ secrets.ACTION_TOKEN }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies
      run: npm install

    - name: Normalize URL
      id: normalize
      run: |
        URL="${{ github.event.inputs.book_url }}"
        NORMALIZED_URL=$(echo "$URL" | sed -e 's/^http:/https:/' \
                                           -e 's,://[^.]\+\.scribd\.com,://www.scribd.com,' \
                                           -e 's,://[^.]\+\.slideshare\.net,://www.slideshare.net,' \
                                           -e 's,://[^.]\+\.everand\.com,://www.everand.com,')
        echo "url=$NORMALIZED_URL" >> $GITHUB_OUTPUT

    - name: Run downloader
      id: downloader
      run: |
        npm start "${{ steps.normalize.outputs.url }}"
        BOOK_FILENAME=$(ls output/* | head -n 1)
        echo "book_filename=$(basename "$BOOK_FILENAME")" >> $GITHUB_OUTPUT

    - name: Install and configure rclone
      env:
        RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
      run: |
        sudo apt-get update && sudo apt-get install -y rclone
        mkdir -p ~/.config/rclone
        echo "$RCLONE_CONF" > ~/.config/rclone/rclone.conf

    - name: Upload to 1Drive and get link
      id: onedrive
      run: |
        BOOK_FILENAME="${{ steps.downloader.outputs.book_filename }}"
        rclone copy "output/$BOOK_FILENAME" "1drive:Scribd_download" --progress
        # Äáº£m báº£o link Ä‘Æ°á»£c táº¡o ngay cáº£ khi file Ä‘Ã£ tá»“n táº¡i
        PUBLIC_LINK=$(rclone link "1drive:Scribd_download/$BOOK_FILENAME")
        echo "public_link=$PUBLIC_LINK" >> $GITHUB_OUTPUT

    # ===== BÆ¯á»šC QUAN TRá»ŒNG 1: Táº O Tá»†P TIN NHáº®N =====
    - name: Create Result Message
      if: success()
      run: |
        echo "âœ… **Táº£i tÃ i liá»‡u Scribd hoÃ n táº¥t!**" > telegram_message.txt
        echo "" >> telegram_message.txt
        echo "ðŸ“„ **Tá»‡p:** `${{ steps.downloader.outputs.book_filename }}`" >> telegram_message.txt
        echo "ðŸ”— **Link:** [Táº£i vá»](${{ steps.onedrive.outputs.public_link }})" >> telegram_message.txt

    # ===== BÆ¯á»šC QUAN TRá»ŒNG 2: Táº¢I LÃŠN ARTIFACT =====
    - name: Upload Result Message
      if: success() && hashFiles('telegram_message.txt') != ''
      uses: actions/upload-artifact@v4
      with:
        name: result-message-${{ github.run_id }}
        path: telegram_message.txt
        retention-days: 1