name: "Intelligent Crawler"

on:
  workflow_dispatch:
    inputs:
      FROM_ID:
        description: "ID sách bắt đầu"
        required: true
        default: "1"
      TO_ID:
        description: "ID sách kết thúc"
        required: true
        default: "10"
      THREADS:
        description: "Số luồng tải ảnh đồng thời (max threads)"
        required: true
        default: "16"

env:
  TZ: Asia/Ho_Chi_Minh
  PYTHONUNBUFFERED: "1"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

jobs:
  crawl:
    runs-on: ubuntu-22.04
    timeout-minutes: 720
    env:
      FROM_ID: ${{ github.event.inputs.FROM_ID }}
      TO_ID: ${{ github.event.inputs.TO_ID }}
      THREADS: ${{ github.event.inputs.THREADS }}
      BHLNK_EMAIL: ${{ secrets.BHLNK_EMAIL }}
      BHLNK_PASSWORD: ${{ secrets.BHLNK_PASSWORD }}
      PYTHONPATH: ${{ github.workspace }}
      RCLONE_DEST: ${{ secrets.RCLONE_DEST || '1drive:/LSC_Books' }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 1024
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: 'proplayer1131/sachyhocpdf_downloader-main'
          token: ${{ secrets.ACTION_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y python3-tk jq

      - name: Install Python dependencies
        run: |
          python -m pip install -U pip
          pip install requests Pillow psutil
          if [ -f requirements.txt ]; then
            grep -v -E 'tkinter|pywin32|win32mica|upx|customtkinter|futures|tqdm' requirements.txt > requirements_linux.txt
            pip install -r requirements_linux.txt
          fi

      - name: Install and configure rclone
        env:
          RCLONE_CONF_CONTENTS: ${{ secrets.RCLONE_CONF }}
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          printf "%s" "$RCLONE_CONF_CONTENTS" > ~/.config/rclone/rclone.conf
          rclone version

      - name: Run Intelligent Crawl Script
        run: python -u scripts/crawl_range.py | tee crawl.log

      - name: Upload downloaded books
        run: |
          set -euo pipefail
          shopt -s nullglob
          
          # Tìm tất cả các thư mục chứa sách đã được tải về (có chứa book_info.json)
          book_folders=(*_*/*book_info.json)

          if [ ${#book_folders[@]} -eq 0 ]; then
            echo "Không có sách nào được tải mới hoặc cập nhật. Bỏ qua upload."
            exit 0
          fi

          echo "Bắt đầu tải lên các sách đã download..."
          for info_file in "${book_folders[@]}"; do
            book_folder=$(dirname "$info_file")
            folder_name=$(basename "$book_folder")
            
            # Chỉ upload nếu có file PDF, tránh upload thư mục rỗng
            if ls "${book_folder}"/*.pdf &> /dev/null; then
              TARGET="${RCLONE_DEST}/${folder_name}"
              echo "Uploading ${folder_name} to ${TARGET}"
              rclone copy "${book_folder}" "${TARGET}" --transfers=8 --checkers=16 --progress
            fi
          done

          echo "Hoàn tất upload."

      - name: Send Success Notification
        if: success()
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ env.TELEGRAM_CHAT_ID }}
          token: ${{ env.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ✅ *Crawl Success!*
            Đã quét xong sách từ ID `${{ env.FROM_ID }}` đến `${{ env.TO_ID }}`.
            Xem chi tiết trong file log đính kèm.
          document: ./crawl.log

      - name: Send Failure Notification
        if: failure() || cancelled()
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ env.TELEGRAM_CHAT_ID }}
          token: ${{ env.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ❌ *Crawl Failed!*
            *Range:* `${{ env.FROM_ID }}` - `${{ env.TO_ID }}`
            *Status:* `${{ job.status }}`
            Xem chi tiết trong file log đính kèm.
          document: ./crawl.log
